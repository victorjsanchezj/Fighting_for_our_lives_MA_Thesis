---
title: "Creating basic cartographies"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    #code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```

## 1) First Steps
We start by loading libraries
```{r}
library(tidyverse)
library(sf)
library(ggspatial)
library(readxl)
library(writexl)
library(sf)
library(tidygeocoder)
```

# 1.a) Creating maps with already existing geospatial information.

The first data sets we will load are shapefiles. Shapefiles are geospatial datasets that contains
the necessary information to produce maps. 

The first dataset we will load is from the Spanish Institue of Geography. It contains data
on the legal limits of Spain's autonomous communities.I obtained this data set form the open
data repository of CLM's government. We will load it and use it as our basic cartography of CLM's
provinces.

#Data for the autonomous communities.

We start by reading the shapefile.

```{r}
CCAA <- st_read("data/recintos_autonomicas_inspire_peninbal_etrs89.shp")
```

Just to check that our data set is properly loaded, let's make our first map!

```{r}


ggplot()+# We are asking R to use the ggplot tools to produce a visualization
  geom_sf(data = CCAA, aes(fill=))+# We are asking R to
  annotation_north_arrow(location="br", which_nort=TRUE,# Here we are adding
                         #a north facing arrow to make the map more 
                         #readable. We are telling r to place it in the
                         #bottom right hand side ("br") and use the real
                         #north as a point of reference.
                         style = north_arrow_fancy_orienteering(), 
                         #this is a mere stylistic decision. I am asking R to
                         #use the style north_arrow_fancy_orienteering
                         #because I like how it looks.
                         height = unit(2.5, "cm"),# We specify the arrow's
                         #height to 2.5cm.
                         width = unit(2.5, "cm"))+# We specify the arrow's
                         #width to 2.5cm.
  annotation_scale()# Lastly, this piece of automatically calculates
  #our map's scale.
```


It works! We have a map.
Now we have to make the dataset more operable. Remember that our goal is to
create a map that situates CLM within Spain. Thus, we will look at the column 
NATCODE. 
The NATCODE is a string of numbers containing information about several 
geographic features.
For instance, the first two characters of a NATCODE tell us which country a given
feature belongs to, whereas the third and fourth characters tell us which autonomous
community is a given place part of. Using this information, I will break down
the column NATCODE and create new columns identifying the country, autonomous
community, province and municipilaty of our data. I promise this is the hardest
bit we will do in this
website! 

```{r}
CCAA_2<- CCAA%>%
  mutate(
    c_country       = str_sub(string = NATCODE, start = 1, end = 2),
    c_CCAA = str_sub(string = NATCODE, start = 3, end = 4),
    c_province  = str_sub(string = NATCODE, start = 5, end = 6),
    cod_ine_municipality  = str_sub(string = NATCODE, start = 7, end = -1))
names(CCAA_2)
```


Now that we have split the NATCODE and created a new column where each Autonomous Community
has its own code, we can situate CLM within Spain.

Firstly, we will create a very simple object containing only the data for CLM. It will
be called "castilla_la_mancha"

```{r}
castilla_la_mancha <- CCAA_2%>% #Here we are asking R to create a new object by looking at
  #the data frame "CCAA_2".
    filter(c_CCAA == "08") # And this code could be read by a human as: "Out of the data frame
# CCAA_2, look for every instance where 08 (CLM's code) appeared in the c_CCAA column". 

```
After creating an object containing the data frame for CLM, we can plot it on top of
our previous map!

```{r}
ggplot()+
  geom_sf (data = CCAA_2, aes(fill=NULL))+ #Use the data frame CCAA_2 to build our basic map
  geom_sf (data = castilla_la_mancha , aes(fill="red"))+ #paint the object
  #contained in castilla_la_mancha (CLM's space) in red
  annotation_north_arrow(location="tr", which_north=TRUE,# 
                         style = north_arrow_fancy_orienteering(),
                         height = unit(2, "cm"),
                         width = unit(2, "cm"))+
  annotation_scale() +
   guides(fill = FALSE)+ #Here I am asking R not to show a label specifying the color
  theme(axis.text = element_blank(), #This part gets rid of the coordinates to make a clearer map,
        #I decided to do so in this map because providing precise geospatial information is not
        #as important in the maps plotting macrogranjas
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank())

```
We are done with out first map! Now, let's figure out where are CLM's provinces ;)

#Data for the provinces within Spain.

Once again, the first step is to load the corresponding shapefile.
```{r}
CLM_provinces <- st_read("data/Provincias.shp") 
```

Great! We have loaded our spatial data set. Please note that the data set is in Spanish,
we will fix that in two steps.

The first step is optional, we are converting our geospatial data into a data frame.
```{r}
CLM_provinces_df <- fortify(CLM_provinces) #This piece of code turns our spatial data set into
# a data frame. A light kind of dataset that R works very well with. You can ommit this step
# if you want to. I did this because my laptop's computing power is not the greastest one ever.

```
Now, comes the most interesting part. We are changing the name of one of the columns that
we need to use later on.

```{r}
CLM_provinces_df <- rename(CLM_provinces_df, 
       Province = NOMBRE) #We are asking R to rename the column "NOMBRE" (name is Spanish) as
# "Province", this will come in handy for our next map.
```

Lastly, we just have to make a map of CLM's provinces

```{r}
CLM_provinces_df %>%
  ggplot(aes(fill=Province, ))+
  scale_fill_brewer(palette = "Reds") +
  geom_sf(color = "black", size = 0.1)+
  theme(axis.text = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_blank(),
    panel.grid = element_blank(),
    axis.title = element_blank())
```

